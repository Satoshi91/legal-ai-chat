# 参考文献の表示の機能仕様

## 概要
AIの応答メッセージの下に、回答の根拠となった法令条文への参考URLを表示する機能を実装する。

## 機能要件

### 1. 基本機能
- AIの回答メッセージの直後に、参考文献情報を表示する
- 参考文献は新しいメッセージロール `reference_url` として実装する
- 各参考文献は、e-gov法令検索サイトへのリンクとして表示する
- リンクをクリックすると新しいウィンドウ/タブで開く

### 2. データソース
- バックエンドAPIの `context_documents` 配列から情報を取得
- 各文書の `metadata` に含まれる以下の情報を使用：
  - `LawID`: 法律ID（例: "129AC0000000089"）
  - `LawTitle`: 法律名（例: "民法"）
  - `ArticleTitle`: 条文名（例: "第五百二十二条"）
  - `document`: 条文内容（リンクテキスト用の抜粋に使用）

### 3. URL生成ルール
- ベースURL: `https://laws.e-gov.go.jp/law/`
- 完全URL: `https://laws.e-gov.go.jp/law/{LawID}`
- 例: `https://laws.e-gov.go.jp/law/129AC0000000089`

## UI仕様

### 1. 表示位置
- AIの回答メッセージの直後
- 通常のメッセージフローに組み込まれる

### 2. 表示形式
- **タイトル形式**: `{LawTitle} {ArticleTitle} {document抜粋}`
- **例**: "民法 第五百二十二条 第五百二十二条\n契約は、契約の内容を示してその締結を申し入れる意思表示..."
- 条文内容は適切な長さに切り詰める（改行文字は考慮しない）

### 3. デザイン要件
- 通常のメッセージとは区別できるスタイル
- クリック可能であることが分かるリンク表示
- 複数の参考文献がある場合は、リスト形式で表示
- ホバー時の視覚的フィードバック

### 4. 動作仕様
- リンククリック時: `window.open(url, '_blank')`で新規ウィンドウ開放
- アクセシビリティ: キーボードナビゲーション対応

## 技術仕様

### 1. 新しいメッセージロール
```typescript
type MessageRole = 'user' | 'assistant' | 'system' | 'reference_url';
```

### 2. 参考文献データ構造
```typescript
interface ReferenceUrlMessage {
  id: string;
  role: 'reference_url';
  content: string;  // 表示テキスト
  url: string;      // リンクURL
  timestamp: Date;
}
```

### 3. context_documentsからの変換ロジック
```typescript
const createReferenceMessages = (contextDocuments: ContextDocument[]): ReferenceUrlMessage[] => {
  return contextDocuments.map((doc, index) => {
    const { LawID, LawTitle, ArticleTitle } = doc.metadata;
    const documentExcerpt = doc.document.substring(0, 50) + '...'; // 抜粋
    
    return {
      id: `ref-${Date.now()}-${index}`,
      role: 'reference_url',
      content: `${LawTitle} ${ArticleTitle} ${documentExcerpt}`,
      url: `https://laws.e-gov.go.jp/law/${LawID}`,
      timestamp: new Date()
    };
  });
};
```

## 実装箇所

### 1. 型定義の更新 (`src/types/legal-chat.ts`)
- `ChatMessage`に`reference_url`ロールを追加
- `ReferenceUrlMessage`インターフェースを定義
- `ContextDocument`のmetadata型を詳細化

### 2. メッセージコンポーネントの更新 (`src/components/Message.tsx`)
- `reference_url`ロールの処理を追加
- リンク表示とクリック処理を実装
- 専用スタイリングを適用

### 3. メイン画面の更新 (`src/app/page.tsx`)
- API応答処理時に参考URLメッセージを生成
- `context_documents`からの変換処理を実装

## テストケース

### 1. 正常系
- 単一の参考文献がある場合の表示
- 複数の参考文献がある場合の表示
- 長い条文内容の切り詰め表示
- リンククリック動作

### 2. 異常系
- `context_documents`が空の場合（参考文献なし）
- メタデータが不完全な場合の処理
- 無効なLawIDの場合の処理

## 実装優先度

1. **P0 (最優先)**: 基本的な参考文献表示機能
2. **P1 (高)**: 複数文献のリスト表示
3. **P2 (中)**: UI/UXの改善（ホバー効果など）
4. **P3 (低)**: 追加機能（条文内容のプレビューなど）

## 制約事項

- 改行文字（\n）の処理は当面考慮しない
- 条文内容の切り詰め長さは固定値で対応
- e-govサイトの利用規約に準拠すること